<div class="upstanders">
  {% include 'Upstanders Header' %}

  <div class="ups-panel ups-intro">
    <div class="ups-intro__content">
      <div class="ups-lead-text ups-intro__lead-text">
        We're standing up to end Trump's corporate coup and make a future where people and planet can thrive
      </div>
      <a class="ups-intro__giant-button ups__giant-button ups__giant-button--teal" href="#join">
        Become an Upstander
      </a>
    </div>
  </div>

  <div class="ups-panel ups-stories">
    <div class="ups-stories__story">
      <div class="ups-stories__circle-image ups-stories__circle-image--signing"></div>
      <div class="ups-stories__text">
        Corporate billionaire Donald Trump has been elected as the 45th President of the United States.
      </div>
    </div>
    <div class="ups-stories__story ups-stories__story--middle">
      <div class="ups-stories__circle-image ups-stories__circle-image--two-execs"></div>
      <div class="ups-stories__text">
        And he’s bringing along his billionaire friends and family to cash in on the benefits, discarding whoever or whatever gets in their way. 
      </div>
    </div>
    <div class="ups-stories__story">
      <div class="ups-stories__circle-image ups-stories__circle-image--hurting"></div>
      <div class="ups-stories__text">
        Including and especially our most vulnerable communities.
      </div>
    </div>
    <div class="ups-stories__wrap-up">
      <strong>The only winners in Trump’s agenda are corporations.</strong>
    </div>
  </div>

  <div class="ups-panel ups-plan">
    That's why we're building a movement
    <br /><br />
    <div class="ups-plan__paragraph">
      We will <a href="/how-we-stand-up">stand up</a> for the world we deserve and stop the Trump administration’s corporate agenda in its tracks.
    </div>
    <br />
    <div class="ups-plan__paragraph">
      And we're going <a href="/how-we-win">to win</a>.
    </div>
  </div>

  <div class="ups-panel ups-join" id="join">
    <div class="ups-join__lead-line">
      Take the first step. Let's stop this coup - together.
    </div>
    <div class="ups-join__content">
      <div class="ups-join__sign-up">
        <div class="ups-join__join-selector">
          <div class="ups-join__join-choice ups-join__join-choice--selected">Individual</div>
          <div class="ups-join__join-choice">Group</div>
        </div>
        <div class="ups-join__form ups-join__form--selected">
          {% include 'Petition', ref: 'Individual' %}
        </div>
        <div class="ups-join__form">
          {% include 'Petition', ref: 'Group' %}
        </div>
      </div>
      <script type="text/javascript">
        $(document).ready(function(){
          $('.ups-join__join-choice').on('click', function(){
            if (!$(this).hasClass('ups-join__join-choice--selected')) {
              $('.ups-join__join-choice').toggleClass('ups-join__join-choice--selected');
              $('.ups-join__form').toggleClass('ups-join__form--selected');
            }
          });
        });
      </script>
      <div class="ups-join__social-proof">
        <script type="text/template" id="proof-template">
          <div class="ups-join__signer">
            <div class="ups-join__signer-name">
              <strong><%= data.name %></strong> <%= data.status %>
            </div>
            <div class="ups-join__time-stamp"><%= data.timestamp %></div>
          </div>
        </script>
        <div class="ups-join__signers"></div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(function(){
    var templater = _.template($('#proof-template').html(), { variable: 'data' });
    var $container = $('.ups-join__signers');
    var ANIMATION_DURATION = 1000;
    var MAX_TO_DISPLAY = 5;
    var HEIGHT_PER = 64;

    var currentTop = 0;
    var currentCount = $container.children().length;

    var add = function(html) {
      $container.append(html);
      currentCount++;
    }

    var capitalize = function(str) {
      return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    }

    var abbreviateName = function(name) {
      var names = name.split(' ');
      var formattedFirstName = capitalize(names[0]);
      if(names[1].length === 0) return formattedFirstName;
      return formattedFirstName + ' ' + names[1].slice(0, 1).toUpperCase() + '.';
    }

    var randomStatus = function() {
      var statuses = ['has had enough.', 'is standing up.', 'is ready.', 'is taking a stand.'];
      return statuses[Math.floor(Math.random() * statuses.length)]
    }

    var format = function(name) {
      return templater({
        name: abbreviateName(name),
        status: randomStatus(),
        timestamp: 'Moments ago'
      });
    }

    var reveal = function() {
      if (currentCount - currentTop > MAX_TO_DISPLAY) {
        currentTop++;
        $container.css('transform', 'translateY(-'+(currentTop * HEIGHT_PER)+'px)');
      }
    }

    var handleAction = function(msg) {
      console.log(msg);
      var data = JSON.parse(msg);
      if (window.slugFilter && data.slug !== window.slugFilter) return;
      add(format(data.first_name + ' ' + data.last_name));
    }

    socket = io('https://actions-api.sumofus.org');
    socket.on('actions', handleAction);

    window.setInterval(reveal, ANIMATION_DURATION);

    $.get('/api/pages/upstanders-homepage/actions', {
      page: 1, per_page: 5
    }, function(data){
      var names = _.map(data.actions, function(action){ return action.name });
      if (names.length > 2) {
        $container.html('')
        currentCount = 0;
      }
      _.each(names, function(name){
        add(format(name));
      });
    });
  });
</script>

{% include 'Upstanders Footer' %}

<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
